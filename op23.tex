%% Copyright (c) 2023, Tom M. Ragonneau
\documentclass[
    % nolicense,  % Whether to include the license frame
]{talk}
\usepackage{array}
\usepackage{fontawesome5}

% Bibliography
\addbibresource{bib/refs.bib}

% Performance profiles
\usepackage{xstring}
\newcommand{\drawprofiles}[3]{%
    \def\selectsolvers{#1}%
    \def\selectcsv{figures/#2}%
    \def\selectprofile{#3}%
    \def\selectxlabel{$\log_2(\text{Perf.\ ratio})$}%
    \def\selectylabel{Perf.\ profiles ($\tau = 10^{-#3}$)}%
    \input{figures/profiles.tex}%
}

% Quoting support
\usepackage[
    begintext=\openautoquote,
    endtext=\closeautoquote,
    vskip=\topsep,
]{quoting}

% Macros dedicated to this presentation
\newcommand*{\ceq}{h}
\newcommand*{\ceqm}[1][]{\hat{\ceq}\ifblank{#1}{}{_{#1}}}
\newcommand*{\cub}{g}
\newcommand*{\cubm}[1][]{\hat{\cub}\ifblank{#1}{}{_{#1}}}
\newcommand*{\iter}[1][]{x\ifblank{#1}{}{_{#1}}}
\newcommand*{\lag}{\mathcal{L}}
\newcommand*{\lagm}[1][]{\widehat{\lag}\ifblank{#1}{}{_{#1}}}
\newcommand*{\lmeq}[1][]{\mu\ifblank{#1}{}{_{#1}}}
\newcommand*{\lmub}[1][]{\lambda\ifblank{#1}{}{_{#1}}}
\newcommand*{\obj}{f}
\newcommand*{\objm}[1][]{\hat{\obj}\ifblank{#1}{}{_{#1}}}
\newcommand*{\rad}[1][]{\Delta\ifblank{#1}{}{_{#1}}}
\newcommand*{\radlb}[1][]{\delta\ifblank{#1}{}{_{#1}}}
\newcommand*{\step}[1][]{s\ifblank{#1}{}{_{#1}}}
\newcommand*{\xl}{l}
\newcommand*{\xpt}[1][]{\mathcal{Y}\ifblank{#1}{}{_{#1}}}
\newcommand*{\xu}{u}

% Headings
\title{COBYQA}
\subtitle{A derivative-free trust-region SQP method for nonlinearly constrained optimization}
\date{OP23 (June 3, 2023)}
\author{\href{https://www.tomragonneau.com}{\textbf{Tom M. Ragonneau}} \and \href{https://www.zhangzk.net}{Zaikun Zhang}}
\institute{
    Department of Applied Mathematics\\
    The Hong Kong Polytechnic University\\
    Hung Hom, Kowloon, Hong Kong\\[\baselineskip]
    This work was supported by the \href{https://cerg1.ugc.edu.hk/hkpfs/index.html}{Hong Kong PhD Fellowship Scheme}.
}
\titlegraphic{}
\hypersetup{
    pdfsubject={OP23},
    pdfkeywords={},
}

\begin{document}

\maketitle

\begin{frame}{General context}
    We design a method named COBYQA for solving
    \begin{equation*}
        \min_{\iter \in \R^n} \quad \obj(\iter) \quad \textrm{s.t.} \quad
        \begin{cases}
            \cub(\iter) \le 0,\\
            \ceq(\iter) = 0,\\
            \xl \le \iter \le \xu,
        \end{cases}
    \end{equation*}
    where derivatives of $\obj$, $\cub$, and $\ceq$ are \alert{unavailable}.

    \medskip

    \begin{block}{Notes on the method}
        \begin{itemize}
            \item COBYQA aims at being a \alert{successor} to \alert{COBYLA} \parencite{Powell_1994}.
            \item We \alert{implement} COBYQA into a Python solver.
            \item The bound constraints are assumed \alert{inviolable}, as
            \begin{itemize}
                \item they often represent \alert{inalienable} restrictions, and
                \item the functions $\obj$, $\cub$, and $\ceq$ may not be defined otherwise.
            \end{itemize}
        \end{itemize}
    \end{block}
\end{frame}

\begin{frame}{Table of contents}
    \tableofcontents[hideallsubsections]
\end{frame}

\section{General framework of COBYQA}

\begin{frame}{The derivative-free trust-region SQP method}

    COBYQA iteratively solves the trust-region SQP subproblem
    \begin{align*}
        \min_{\step \in \R^n}   & \quad \only<1>{\obj}\only<2>{\alert{\objm[k]}}(\iter[k]) + \nabla \only<1>{\obj}\only<2>{\alert{\objm[k]}}(\iter[k])^{\T} \step + \frac{1}{2} \step^{\T} \nabla_{\iter, \iter} ^2 \only<1>{\lag}\only<2>{\alert{\lagm[k]}}(\iter[k], \lmub[k], \lmeq[k]) \step\\
        \textrm{s.t.}           & \quad \only<1>{\cub}\only<2>{\alert{\cubm[k]}}(\iter[k]) + \nabla \only<1>{\cub}\only<2>{\alert{\cubm[k]}}(\iter[k]) \step \le 0,\\
                                & \quad \only<1>{\ceq}\only<2>{\alert{\ceqm[k]}}(\iter[k]) + \nabla \only<1>{\ceq}\only<2>{\alert{\ceqm[k]}}(\iter[k]) \step = 0,\\
                                & \quad \xl \le \iter[k] + \step \le \xu,\\
                                & \quad \norm{\step} \le \rad[k],
    \end{align*}
    with $\only<1>{\lag}\only<2>{\alert{\lagm[k]}}(\iter, \lmub,
    \lmeq) = \only<1>{\obj}\only<2>{\alert{\objm[k]}}(\iter) + \lmub^{\T} \only<1>{\cub}\only<2>{\alert{\cubm[k]}}(\iter) + \lmeq^{\T} \only<1>{\ceq}\only<2>{\alert{\ceqm[k]}}(\iter)$\only<2>{, given some \alert{models}}.

    \medskip
    \pause

    \begin{block}{Remarks on this subproblem}
        \begin{itemize}
            \item We only require an approximate solution $\step[k]$.
            \item The solution must satisfy $\xl \le \iter[k] + \step[k] \le \xu$.
            \item It is \alert{wrong} to replace $\nabla_{\iter, \iter} ^2 \lagm[k](\iter[k], \lmub[k], \lmeq[k])$ with $\nabla^2 \objm[k](\iter[k])$.
        \end{itemize}
    \end{block}
\end{frame}

\begin{frame}{Interpolation-based quadratic models}
    COBYQA models $\obj$, $\cub$, and $\ceq$ by \alert{quadratic} interpolation, as follows.\footnote{Some alternatives: \textcite{Conn_Scheinberg_Toint_1997a,Conn_Scheinberg_Toint_1997b,Conn_Scheinberg_Toint_1998,Wild_2008,Bandeira_Scheinberg_Vicente_2012,Zhang_2014,Xie_Yuan_2023}.}

    \begin{exampleblock}{Derivative-free symmetric Broyden update \parencite{Powell_2004}}
        The $k$th quadratic model $\objm[k]$ of $\obj$ solves
        \begin{equation*}
            \begin{aligned}
                \min_{Q \in \mathcal{Q}_n}  & \quad \norm[\big]{\nabla^2 Q - \nabla^2 \objm[k - 1]}_{\mathsf{F}}\\
                \textrm{s.t.}               & \quad Q(y) = \obj(y), ~ y \in \xpt[k],
            \end{aligned}
        \end{equation*}
        for some $\xpt[k] \subseteq \R^n$, with $\objm[-1] \equiv 0$ (similar for $\cubm[k]$ and $\ceqm[k]$).
    \end{exampleblock}

    The interpolation set $\xpt[k]$ is \alert{recycled} at each iteration.
    \begin{itemize}
        \item We set $\xpt[k + 1] = \big(\xpt[k] \cup \set{\iter[k] + \step[k]}\big) \setminus \set{\bar{y}}$ for some bad point $\bar{y} \in \xpt[k]$.
        \item This variational problem is a QP, with a \alert{linear} KKT system.
    \end{itemize}
\end{frame}

\begin{frame}{Management of the trust-region radius}
    \begin{block}{We maintain $\rad[k]$ and a lower bound $\radlb[k] \le \rad[k]$}
        \begin{itemize}
            \item The lower bound $\radlb[k]$ is \alert{never} increased.
            \item We update $\rad[k]$ in the usual way, but we \alert{always} have $\rad[k] \ge \radlb[k]$.
            \item This strategy is adapted from \alert{Powell}'s methods (e.g., NEWUOA).
        \end{itemize}
    \end{block}

    The value of $\radlb[k]$ is an indicator of the current \alert{resolution}.

    \begin{itemize}
        \item Without $\rad[k] \ge \radlb[k]$, the value of $\rad[k]$ may become too small.
        \item It prevents the interpolation points from \alert{concentrating} too much.
        \item The value of $\radlb[k]$ is only \alert{decreased} when necessary.
        \item Hence, stopping when $\radlb[k] \le \radlb[\textrm{end}]$ is \alert{reasonable} ($\radlb[\textrm{end}] > 0$).
    \end{itemize}

    \medskip

    For more information, see \textcite[\S\ 5.2.5]{Ragonneau_2022}.
\end{frame}

\begin{frame}{There remain many difficulties to address}
    \begin{itemize}
        \setlength\itemsep{0.5em}
        \item What if the trust-region subproblem is \alert{infeasible}?\\
        \textcolor{FernGreen}{COBYQA uses a Byrd-Omojokun composite-step approach.}
        \item How to calculate the trial step $\step[k]$ \alert{numerically}?\\
        \textcolor{FernGreen}{We adapt the truncated conjugate gradient method.}
        \item What are the approximate Lagrange multipliers $\lmub[k]$ and $\lmeq[k]$?\\
        \textcolor{FernGreen}{We choose the least-squares Lagrange multipliers.}
        \item How to define a trust-region ratio? Using what merit function?\\
        \textcolor{FernGreen}{COBYQA uses the $\ell_2$-merit function.}
        \item What if the set $\xpt[k]$ is (almost) nonpoised?\\
        \textcolor{FernGreen}{We use a geometry-improving mechanism.}
    \end{itemize}

    \medskip

    These questions (and more) are addressed in \textcite{Ragonneau_2022}.
\end{frame}

\section{A new interpretation of the SQP subproblem}

\begin{frame}{General settings}
    \begin{block}{}
        \faIcon{exclamation-triangle} This part is \alert{not} DFO and focuses on SQP.
    \end{block}

    For simplicity, we consider the \alert{smooth} problem
    \begin{equation*}
        \min_{\iter \in \R^n} \quad \obj(\iter) \quad \textrm{s.t.} \quad \ceq(\iter) = 0,
    \end{equation*}
    and we denote by $\lag$ its Lagrangian, given by
    \begin{equation*}
        \lag(\iter, \lmeq) = \obj(\iter) + \lmeq^{\T} \ceq(\iter).
    \end{equation*}

    \begin{block}{A curve on the level surface of the constraints}
        We consider a \alert{curve} parametrized by $\xi : \R \to \R^n$ with
        \begin{equation*}
            \ceq\big(\xi(t)\big) = \ceq(\bar{\iter}) \quad \text{for all $t \in \R$} \quad \text{and} \quad \xi(0) = \bar{\iter}.
        \end{equation*}
        Note that $\bar{\iter}$ can be \alert{infeasible}, i.e., $\ceq(\bar{\iter}) \neq 0$.
    \end{block}
\end{frame}

\begin{frame}{The new interpretation}
    Recall that the objective function of the SQP subproblem at $(\bar{\iter}, \bar{\lmeq})$ is
    \begin{equation*}
        Q(\step) = \obj(\bar{\iter}) + \nabla \obj(\bar{\iter})^{\T} \step + \frac{1}{2} \step^{\T} \textcolor{FernGreen}{\only<1,3->{\nabla_{\iter, \iter}^2 \lag(\bar{\iter}, \bar{\lmeq})}\only<2>{\nabla^2 \obj(\bar{\iter})}} \step.
    \end{equation*}

    \begin{alertblock}{Main result (Ragonneau and Zhang, 2022)}
        If $\obj$, $\ceq$, and $\xi$ have locally Lipschitz second-order derivatives, then
        \begin{equation*}
            \abs[\big]{\obj\big(\xi(t)\big) - Q\big(\xi'(0)t\big)} \le \bigg(\nu t + \frac{1}{2} \abs[\big]{\xi''(0)^{\T} \textcolor{FernGreen}{\only<1,3->{\nabla_{\iter} \lag(\bar{\iter}, \bar{\lmeq})}\only<2>{\nabla \obj(\bar{\iter})}}}\bigg) t^2
        \end{equation*}
        for some $\nu \ge 0$, $\epsilon > 0$, and all $t \in (-\epsilon, \epsilon)$.
    \end{alertblock}

    \medskip

    \begin{itemize}
        \item<3-> Note that if $(\bar{\iter}, \bar{\lmeq})$ is \alert{almost} a KKT pair, then $\nabla_{\iter} \lag(\bar{\iter}, \bar{\lmeq}) \approx 0$.
        \item<4> What does the line $\set{\xi'(0)t}_{t \in \R}$ represent?
    \end{itemize}

\end{frame}

\begin{frame}{The new interpretation (cont'd)}
    \begin{center}
        \begin{tikzpicture}[rotate=301]
            \draw[thick,VeniceBlue] plot[smooth,tension=1] coordinates {(0,2) (2,3) (3,6)};
            \draw[thick,Mahogany] plot[smooth,tension=1] coordinates {(2,-0.5) (4,1) (6,4)};
            \draw[thick,DarkCaramel] (0,1/3) -- (4.5,19/3);
            \draw[thick,FernGreen] (1,-2/3) -- (6,18/3);
            \draw[latex-latex] (1,5/3) -- (53/25,62/75);

            \node at (2,3) {$\bullet$};

            \node[above] at (2,3) {$\bar{\iter}$};
            \node[right,yshift=-0.1cm] at (39/25,187/150) {$\norm[\big]{\nabla \ceq(\bar{\iter})^{\dagger} \ceq(\bar{\iter})}$};
            \node[above,VeniceBlue,xshift=0.5cm] at (3,6) {$\ceq^{-1}(\bar{\iter})$};
            \node[above,DarkCaramel,xshift=0.5cm,yshift=0.15cm] at (4.5,19/3) {$\bar{\iter} + \ker \nabla \ceq(\bar{\iter})$};
            \node[above,FernGreen,xshift=-0.5cm,yshift=0.4cm] at (6,18/3) {$\bar{x} + \set{\step \in \R^n : \ceq(\bar{\iter}) + \nabla \ceq(\bar{\iter}) \step = 0}$};
            \node[above,Mahogany,xshift=0.5cm] at (6,4) {$\ceq^{-1}(0)$};
        \end{tikzpicture}
    \end{center}

    \begin{itemize}
        \item The \textcolor{FernGreen}{green} line represents the feasible set of the SQP subproblem.
        \item If $\ceq(\bar{\iter}) = 0$, the \textcolor{FernGreen}{green} and \textcolor{DarkCaramel}{yellow} lines overlap.
        \item The \textcolor{FernGreen}{green} line is shifted towards feasibility, because
        \begin{equation*}
            \norm[\big]{\ceq(\bar{\iter} + \step)} = \mathcal{O}\big(\norm[\big]{\ceq(\bar{\iter})}^2\big)
        \end{equation*}
    \end{itemize}
\end{frame}

\section{Implementation and experiments}

\begin{frame}{The Python implementation of COBYQA}
    \begin{block}{From \textcite{Powell_2006}}
        \begin{quoting}
            \small%
            The development of NEWUOA has taken nearly \alert{three years}.
            The work was very \alert{frustrating} [\dots]
        \end{quoting}
        The development of COBYQA was \alert{not easier}.
    \end{block}

    \smallskip

    We implemented COBYQA in \alert{Python} and made it publicly available.

    \smallskip

    \begin{center}
        \qrcode{https://www.cobyqa.com}\\[1ex]
        \href{https://www.cobyqa.com}{\texttt{www.cobyqa.com}}
    \end{center}

    \begin{block}{}
        \texttt{\$ pip install cobyqa}
    \end{block}
\end{frame}

\begin{frame}{Comparing COBYQA with existing DFO solvers}
    \begin{itemize}
        \item We assess the quality of points based on the merit function
        \begin{equation*}
            \varphi(\iter) =
            \begin{cases}
                \obj(\iter)                           & \text{if~$v_{\infty}(x) \le 10^{-10}$,}\\
                \infty                                & \text{if~$v_{\infty}(x) \ge 10^{-5}$,}\\
                \obj(\iter) + 10^5 v_{\infty}(\iter)  & \text{otherwise,}
            \end{cases}
        \end{equation*}
        where~$v_{\infty}$ denotes the~$\ell_{\infty}$-constraint violation.
        \item The problems are from the \alert{CUTEst} set.
        \item The problems are of \alert{dimension} at most \num{50} (this is \alert{not} small).
        \item Problems with \alert{inviolable} bounds replace $\obj$ with
        \begin{equation*}
            \tilde{\obj}(x) =
            \begin{cases}
                \obj(x) & \text{if~$\xl \le x \le \xu$,}\\
                \infty  & \text{otherwise.}
            \end{cases}
        \end{equation*}
    \end{itemize}
\end{frame}

\begin{frame}{Performance of the SQP approach}
    We compare two strategies for evaluating the Lagrange multipliers
    \begin{itemize}
        \item on \alert{nonlinearly constrained} problems,
        \item comparing the default and the \alert{erroneous} ($\lmub[k] = 0$ and $\lmeq[k] = 0$) ones.
    \end{itemize}

    \smallskip

    \begin{center}
        \drawprofiles{{"Default","Erroneous"}}{plain-1-50-perf-cobyqa-wrong-hessian-qo.csv}{4}
    \end{center}
\end{frame}

\begin{frame}{Performance on linearly constrained problems}
    We compare COBYQA, LINCOA, and COBYLA
    \begin{itemize}[<+->]
        \item on \alert{linearly constrained} problems,
        \item with \alert{inviolable} bounds.
    \end{itemize}

    \smallskip

    \begin{center}
        \only<1>{\drawprofiles{{"COBYQA","LINCOA","COBYLA"}}{plain-1-50-perf-cobyla-cobyqa-lincoa-nl.csv}{4}}%
        \only<2>{\drawprofiles{{"COBYQA","LINCOA","COBYLA"}}{plain-1-50-perf-cobyla-cobyqa-lincoa-nl-bounds.csv}{4}}
    \end{center}
\end{frame}

\begin{frame}{Performance on nonlinearly constrained problems}
    We compare COBYQA and COBYLA
    \begin{itemize}[<+->]
        \item on \alert{nonlinearly constrained} problems,
        \item with \alert{inviolable} bounds.
    \end{itemize}

    \smallskip

    \begin{center}
        \only<1>{\drawprofiles{{"COBYQA","COBYLA"}}{plain-1-50-perf-cobyla-cobyqa-qo.csv}{4}}%
        \only<2>{\drawprofiles{{"COBYQA","COBYLA"}}{plain-1-50-perf-cobyla-cobyqa-qo-bounds.csv}{4}}
    \end{center}
\end{frame}

\begin{frame}{Comparison with COBYLA}
    We compare COBYQA and COBYLA on \alert{all} 388 problems.

    \bigskip

    \begin{center}
        \drawprofiles{{"COBYQA","COBYLA"}}{plain-1-50-perf-cobyla-cobyqa-ubnlqo.csv}{4}
    \end{center}
\end{frame}

\section{Conclusion}

\begin{frame}{Conclusion}
    We presented our new method COBYQA.
    \begin{itemize}
        \item It already received \alert{positive} feedback from practitioners.
        \item It will soon be included in the Python packages PDFO and GEMSEO.
    \end{itemize}

    We stated a new interpretation of the SQP subproblem.
    \begin{itemize}
        \item Does it provide new insights into \alert{manifold optimization}?
        \item Can these insights help the theoretical analysis of COBYQA?
    \end{itemize}

    \begin{center}
        \qrcode{https://www.cobyqa.com}\\[1ex]
        \href{https://www.cobyqa.com}{\texttt{www.cobyqa.com}}
    \end{center}

    \begin{block}{}
        \texttt{\$ pip install cobyqa}
    \end{block}
\end{frame}


\appendix
\begin{frame}[t,allowframebreaks]{References}
    \printbibliography[heading=none]
\end{frame}

\end{document}
